<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vai Dar Maré! (Natal/RN)</title>
    <!-- Carrega o Tailwind CSS para styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* Azul muito claro */
            color: #1e3a8a; /* Azul marinho escuro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
    </style>
</head>
<body class="bg-blue-50">

<div id="app" class="w-full max-w-md bg-white p-6 md:p-8 rounded-2xl shadow-2xl transform transition duration-500 hover:shadow-3xl">
    <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-6 text-teal-600">
        Vai Dar Maré!
    </h1>

    <!-- Formulário de Consulta -->
    <div class="space-y-4 mb-8">
        <!-- Localização Fixa (P24427 - Natal/RN) -->
        <p class="text-sm font-semibold text-gray-500 text-center">
            Localização Fixa: Natal/RN (ID P24427)
        </p>

        <!-- Campo de Data -->
        <div>
            <label for="date-input" class="block text-sm font-medium text-blue-800 mb-1">Selecione a Data:</label>
            <input type="date" id="date-input" class="w-full p-3 border border-blue-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" value="2025-10-19">
        </div>

        <!-- Botão de Consulta -->
        <button id="query-button" class="w-full p-3 font-semibold text-white rounded-lg bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-teal-300">
            Consultar Marés
        </button>
    </div>

    <!-- Resultados -->
    <div id="results-container" class="space-y-4">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2 mb-4">
            Eventos de Maré de Natal/RN
        </h2>
        
        <!-- Placeholder/Mensagens -->
        <div id="loading-message" class="hidden text-center text-teal-600">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Buscando dados...
        </div>
        <div id="error-message" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
        <ul id="tide-list" class="space-y-3">
            <!-- Os resultados serão injetados aqui -->
        </ul>
    </div>
</div>

<script>
    // Configurações Globais
    const API_BASE_PATH = '/api/tide';
    const LOCATION_ID = 'P24427'; // Natal/RN

    // Elementos do DOM
    const dateInput = document.getElementById('date-input');
    const queryButton = document.getElementById('query-button');
    const loadingMessage = document.getElementById('loading-message');
    const errorMessage = document.getElementById('error-message');
    const tideList = document.getElementById('tide-list');

    // Funções de Utilidade
    function showLoading(show) {
        queryButton.disabled = show;
        queryButton.textContent = show ? 'Consultando...' : 'Consultar Marés';
        loadingMessage.classList.toggle('hidden', !show);
        errorMessage.classList.add('hidden');
        tideList.innerHTML = '';
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    function formatTime(isoTime) {
        // Ex: 2025-10-19T02:29-03:00 -> 02:29
        try {
            const date = new Date(isoTime);
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
        } catch (e) {
            return 'N/A';
        }
    }

    function renderTideEvent(event) {
        const isHigh = event.type === 'H';
        const typeText = isHigh ? 'Maré Alta' : 'Maré Baixa';
        const typeClass = isHigh ? 'bg-blue-200 text-blue-900 border-blue-400' : 'bg-teal-100 text-teal-800 border-teal-400';
        const heightUnit = event.height ? parseFloat(event.height).toFixed(2) + ' m' : 'N/A';
        const formattedTime = formatTime(event.fxTime);

        return `
            <li class="flex justify-between items-center p-4 rounded-xl border-l-4 ${typeClass} shadow-sm">
                <!-- Altura (Destaque Principal) -->
                <div class="text-3xl font-extrabold text-blue-800 flex-shrink-0">
                    ${heightUnit}
                </div>
                
                <!-- Tipo e Hora -->
                <div class="text-right">
                    <div class="text-lg font-bold">
                        ${typeText}
                    </div>
                    <div class="text-sm font-semibold text-gray-700 mt-1">
                        às ${formattedTime}
                    </div>
                </div>
            </li>
        `;
    }

    // Lógica da Consulta
    async function fetchTideData() {
        const rawDate = dateInput.value;
        if (!rawDate) {
            showError("Por favor, selecione uma data.");
            return;
        }

        // Formata a data para YYYYMMDD (necessário pela QWeather)
        const formattedDate = rawDate.replace(/-/g, '');
        
        // Constrói a URL para a Serverless Function do Vercel
        const url = `${API_BASE_PATH}?location=${LOCATION_ID}&date=${formattedDate}`;

        showLoading(true);

        try {
            const response = await fetch(url);
            
            // O Vercel retorna a resposta JSON da QWeather
            const data = await response.json();

            // 1. Checagem de Erros da QWeather (código != 200)
            if (data.code && data.code !== '200') {
                const apiError = data.code === '403' 
                    ? `ERRO QWEATHER (Código 403): Chave Inválida ou Serviço de Marés não ativado. Por favor, verifique no painel da QWeather.` 
                    : `Erro QWeather (Código ${data.code}): ${data.code}`;
                showError(apiError);
                return;
            }

            // 2. Checagem de Dados Válidos (usando 'tideTable' conforme descoberto)
            const tideEvents = data.tideTable; 

            if (!tideEvents || tideEvents.length === 0) {
                showError("Nenhum evento de maré (Alta/Baixa) encontrado para esta data ou localização.");
                return;
            }

            // 3. Renderização dos Resultados
            const html = tideEvents.map(renderTideEvent).join('');
            tideList.innerHTML = html;

        } catch (error) {
            console.error("Erro no fetch:", error);
            showError("Erro na comunicação com o servidor. Verifique sua conexão ou os logs do Vercel.");
        } finally {
            showLoading(false);
        }
    }

    // Listeners de Eventos
    queryButton.addEventListener('click', fetchTideData);

    // Inicialização (Setar a data inicial de teste no input)
    window.onload = () => {
        const today = new Date();
        // Define a data de teste inicial (2025-10-19)
        dateInput.value = "2025-10-19";
        // fetchTideData(); // Pode rodar a consulta inicial se desejar
    };

</script>

</body>
</html>

