<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vai Dar Maré!</title>
    <link rel="manifest" href="/manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playwrite+DE+SAS:wght@100..400&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Oswald como padrão para o body, exceto onde 'cursive-title' é aplicado */
        body {
            font-family: 'Oswald', sans-serif;
            background-color: #001F4F; /* Azul Profundo: Fundo da página */
        }
        /* Estilos adicionais para botões e cards */
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(5px); /* Menos blur para leveza */
        }
        .cursive-title {
            font-family: 'Playwrite DE SAS', cursive;
            font-weight: 400; /* Peso padrão para a fonte */
        }
        /* Utilitários Tailwind customizados */
        .text-title-color {
            color: #FFD700; /* Dourado */
        }
        .bg-card-bg {
            background-color: rgba(255, 255, 255, 0.85); /* Branco quase transparente */
        }
        .bg-blue-dark {
            background-color: #001F4F;
        }
        .text-tide-high {
            color: #0080FF; /* Azul Claro para Alta */
        }
        .text-tide-low {
            color: #CC0000; /* Vermelho para Baixa */
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

    <div class="w-full max-w-md">
        <header class="text-center mb-6">
            <h1 class="cursive-title text-4xl font-bold text-title-color mb-1">
                Vai Dar Maré!
            </h1>
            <p class="text-white text-lg">Tábua de Marés de Natal/RN</p>
        </header>

        <main class="card p-6 rounded-xl border border-white/50">
            
            <form id="tide-form" class="space-y-4 mb-6">
                <div class="flex flex-col">
                    <label for="date-input" class="text-gray-700 font-medium mb-1">Selecione a Data:</label>
                    <input type="date" id="date-input" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-dark focus:border-blue-dark transition duration-150">
                </div>
                
                <button type="submit" id="submit-btn" class="w-full bg-blue-dark text-white p-3 rounded-lg font-semibold hover:bg-blue-900 transition duration-150 flex items-center justify-center space-x-2 disabled:opacity-50">
                    <span id="btn-text">Consultar</span>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>

            <div id="results-container" class="p-4 rounded-lg border border-gray-300 bg-card-bg transition-colors duration-300">
                <p id="message" class="text-center text-gray-700 font-medium">Selecione uma data para ver a tábua de marés.</p>
                <div id="tide-list" class="hidden">
                    </div>
            </div>

        </main>

        <footer class="text-center mt-6 text-white text-sm opacity-80">
            <p>Dados fornecidos pela Stormglass API. Horários em UTC/GMT.</p>
        </footer>
    </div>

    <script>
        // Variáveis do DOM
        const form = document.getElementById('tide-form');
        const dateInput = document.getElementById('date-input');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const message = document.getElementById('message');
        const tideList = document.getElementById('tide-list');
        const resultsContainer = document.getElementById('results-container');

        // URL base para a nossa Serverless Function (proxy)
        const API_BASE_URL = '/api/tide'; 

        // --- Funções Auxiliares ---

        // Função para obter a data de hoje no formato YYYY-MM-DD
        const getTodayDate = () => {
            const today = new Date();
            return today.toISOString().split('T')[0];
        };

        // Função para formatar o tempo ISO 8601 (ex: "2023-11-01T15:10:00+00:00") para HH:MM
        const formatTime = (isoTime) => {
            try {
                // Stormglass retorna em UTC, então especificamos 'UTC' para garantir que 
                // a conversão não seja afetada pelo fuso horário local do cliente, mantendo o horário da API.
                const date = new Date(isoTime); 
                return date.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: false,
                    timeZone: 'UTC' 
                });
            } catch (e) {
                return 'N/A';
            }
        };

        // Função para mostrar o estado de carregamento
        const showLoading = (isLoading) => {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                submitBtn.disabled = true;
                btnText.textContent = 'Buscando...';
            } else {
                loadingSpinner.classList.add('hidden');
                submitBtn.disabled = false;
                btnText.textContent = 'Consultar';
            }
        };

        // Função para mostrar mensagens de erro
        const showError = (errorMessage) => {
            tideList.classList.add('hidden');
            message.textContent = errorMessage;
            message.classList.remove('hidden');
            // Estilo de erro
            resultsContainer.classList.remove('bg-card-bg', 'bg-tide-high/20', 'border-tide-high/50', 'bg-yellow-100', 'border-yellow-400');
            resultsContainer.classList.add('bg-red-100', 'border-red-400');
            showLoading(false);
        };
        
        // Função para exibir os dados na lista - Adaptada para Stormglass
        const displayTideData = (stormglassEvents) => {
            
            let resultsHtml = `
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-2 text-title-color">Natal/RN - Eventos de Maré (UTC/GMT)</h2>
            `; 

            resultsHtml += `<div class="w-full mt-4 space-y-3">`;

            // stormglassEvents é o array 'data'
            stormglassEvents.forEach(event => {
                // Stormglass usa 'high' ou 'low'
                const isHighTide = event.type === 'high'; 
                const icon = isHighTide ? '▲' : '▼';
                
                // Classes Tailwind customizadas
                const color = isHighTide ? 'text-tide-high' : 'text-tide-low';
                const borderColor = isHighTide ? 'border-tide-high/50' : 'border-tide-low/50';
                const label = isHighTide ? 'Maré Alta' : 'Maré Baixa';

                // Stormglass retorna 'height' e 'time'
                resultsHtml += `
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white border shadow-sm ${borderColor}">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl font-bold ${color}">${icon}</span>
                            <div>
                                <p class="font-medium text-gray-900">${label}</p>
                                <p class="text-xs text-gray-500">Altura: ${event.height.toFixed(2)}m</p>
                            </div>
                        </div>
                        <span class="text-lg font-bold text-gray-700">${formatTime(event.time)}</span>
                    </div>
                `;
            });

            resultsHtml += `</div>`; 
            tideList.innerHTML = resultsHtml;

            message.textContent = '';
            message.classList.add('hidden');
            tideList.classList.remove('hidden');
            // Estilo de sucesso
            resultsContainer.classList.remove('bg-card-bg', 'bg-red-100', 'bg-yellow-100', 'border-red-400', 'border-yellow-400');
            resultsContainer.classList.add('bg-tide-high/20', 'border-tide-high/50');
        };

        // --- Lógica Principal de Consulta ---
        async function fetchTideData(dateString) {
            // dateString já está no formato YYYY-MM-DD, que é o que o backend espera como parâmetro 'date'
            const url = `${API_BASE_URL}?date=${dateString}`; 

            showLoading(true);
            message.textContent = 'Buscando dados...';
            message.classList.remove('hidden'); 
            // Estilo de busca
            resultsContainer.classList.remove('bg-red-100', 'border-red-400', 'bg-tide-high/20', 'border-tide-high/50', 'bg-yellow-100', 'border-yellow-400');
            resultsContainer.classList.add('bg-card-bg', 'border-gray-300');

            try {
                const response = await fetch(url);
                // Tentar ler como JSON, pois o backend Serverless envia JSON (incluindo JSON de erro)
                const data = await response.json(); 

                if (!response.ok) {
                    let errorMessage = 'Ocorreu um erro desconhecido na comunicação.';
                    if (response.status === 429) {
                        errorMessage = 'ERRO STORMGLASS (429): Limite de Requisições (Rate Limit) Atingido. Tente novamente mais tarde.';
                    } else if (response.status === 403) {
                         errorMessage = 'ERRO STORMGLASS (403): Chave Inválida ou Plano sem Acesso a Marés. Verifique a Variável de Ambiente.';
                    } else if (data.error) {
                        // Erro vindo do nosso Serverless Function
                        errorMessage = `Erro do Servidor (${response.status}): ${data.error}. Detalhes: ${data.details}`;
                    } else {
                        errorMessage = `Erro de Conexão: Status HTTP ${response.status}.`;
                    }
                    
                    showError(errorMessage);
                    return;
                }
                
                // Stormglass retorna os eventos de maré dentro de um array chamado 'data'
                const tideEvents = data.data; 

                if (tideEvents && tideEvents.length > 0) {
                    displayTideData(tideEvents);
                } else {
                    message.textContent = 'Nenhum evento de maré (Alta/Baixa) encontrado para esta data ou local.';
                    message.classList.remove('hidden');
                    tideList.classList.add('hidden');
                    // Estilo de aviso
                    resultsContainer.classList.remove('bg-card-bg', 'bg-tide-high/20', 'border-tide-high/50');
                    resultsContainer.classList.add('bg-yellow-100', 'border-yellow-400');
                }

            } catch (error) {
                console.error('Erro de rede ou Serverless Function:', error);
                showError(`Erro de Comunicação: Verifique a sua conexão ou os logs do Vercel. Detalhe: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }


        // Listener do Formulário
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const dateString = dateInput.value;
            
            if (dateString) {
                fetchTideData(dateString); 
            }
        });

        // Inicialização: Define a data de hoje por padrão
        window.onload = () => {
            dateInput.value = getTodayDate();
        };

        // Registro do Service Worker para o PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha no registro do Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
