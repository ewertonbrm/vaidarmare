<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vai Dar Maré! (Versão Estável)</title>
    <!-- Carrega o Tailwind CSS para styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6; /* Fundo cinza claro */
            padding: 20px;
        }
    </style>
</head>
<body>

<div id="app" class="w-full max-w-md bg-white p-6 md:p-8 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">
        Vai Dar Maré!
    </h1>

    <!-- Formulário de Consulta -->
    <div class="space-y-4 mb-8">
        <!-- Localização Fixa -->
        <p class="text-sm font-medium text-gray-500 text-center">
            Localização Fixa: Natal/RN (ID P24427)
        </p>

        <!-- Campo de Data -->
        <div>
            <label for="date-input" class="block text-sm font-medium text-gray-700 mb-1">Selecione a Data:</label>
            <input type="date" id="date-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="2025-10-19">
        </div>

        <!-- Botão de Consulta -->
        <button id="query-button" class="w-full p-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
            Consultar Marés
        </button>
    </div>

    <!-- Resultados -->
    <div id="results-container" class="space-y-4">
        <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">
            Eventos de Maré de Natal/RN
        </h2>
        
        <!-- Placeholder/Mensagens -->
        <div id="loading-message" class="hidden text-center text-blue-600">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Buscando dados...
        </div>
        <div id="error-message" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
        <ul id="tide-list" class="space-y-3">
            <!-- Os resultados serão injetados aqui -->
        </ul>
    </div>
</div>

<script>
    // Configurações Globais
    const API_BASE_PATH = '/api/tide';
    const LOCATION_ID = 'P24427'; // Natal/RN

    // Elementos do DOM
    const dateInput = document.getElementById('date-input');
    const queryButton = document.getElementById('query-button');
    const loadingMessage = document.getElementById('loading-message');
    const errorMessage = document.getElementById('error-message');
    const tideList = document.getElementById('tide-list');

    // Funções de Utilidade
    function showLoading(show) {
        queryButton.disabled = show;
        queryButton.textContent = show ? 'Consultando...' : 'Consultar Marés';
        loadingMessage.classList.toggle('hidden', !show);
        errorMessage.classList.add('hidden');
        tideList.innerHTML = '';
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    function formatTime(isoTime) {
        // Ex: 2025-10-19T02:29-03:00 -> 02:29
        try {
            const date = new Date(isoTime);
            // Formata para HH:MM no fuso local
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
        } catch (e) {
            return 'N/A';
        }
    }

    function renderTideEvent(event) {
        const isHigh = event.type === 'H';
        const typeText = isHigh ? 'Maré Alta' : 'Maré Baixa';
        const typeClass = isHigh ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700';
        const heightUnit = event.height ? parseFloat(event.height).toFixed(2) + ' m' : 'N/A';
        const formattedTime = formatTime(event.fxTime);

        return `
            <li class="flex justify-between items-center p-4 rounded-lg border-l-4 border-blue-500 ${typeClass} shadow-sm">
                <!-- Altura (Destaque Principal) -->
                <div class="text-2xl font-extrabold text-indigo-700 flex-shrink-0">
                    ${heightUnit}
                </div>
                
                <!-- Tipo e Hora -->
                <div class="text-right">
                    <div class="text-md font-semibold">
                        ${typeText}
                    </div>
                    <div class="text-sm font-medium text-gray-600 mt-0.5">
                        às ${formattedTime}
                    </div>
                </div>
            </li>
        `;
    }

    // Lógica da Consulta
    async function fetchTideData() {
        const rawDate = dateInput.value;
        if (!rawDate) {
            showError("Por favor, selecione uma data.");
            return;
        }

        // Formata a data para YYYYMMDD (necessário pela QWeather)
        const formattedDate = rawDate.replace(/-/g, '');
        
        // Constrói a URL para a Serverless Function do Vercel
        const url = `${API_BASE_PATH}?location=${LOCATION_ID}&date=${formattedDate}`;

        showLoading(true);

        try {
            const response = await fetch(url);
            
            const data = await response.json();

            // 1. Checagem de Erros da QWeather (código != 200)
            if (data.code && data.code !== '200') {
                const apiError = data.code === '403' 
                    ? `ERRO QWEATHER (Código 403): Chave Inválida ou Serviço de Marés não ativado. Por favor, verifique no painel da QWeather.` 
                    : `Erro QWeather (Código ${data.code}): ${data.code}`;
                showError(apiError);
                return;
            }

            // 2. Checagem de Dados Válidos (usando 'tideTable')
            const tideEvents = data.tideTable; 

            if (!tideEvents || tideEvents.length === 0) {
                showError("Nenhum evento de maré (Alta/Baixa) encontrado para esta data ou localização.");
                return;
            }

            // 3. Renderização dos Resultados
            const html = tideEvents.map(renderTideEvent).join('');
            tideList.innerHTML = html;

        } catch (error) {
            console.error("Erro no fetch:", error);
            showError("Erro na comunicação com o servidor. Verifique sua conexão ou os logs do Vercel.");
        } finally {
            showLoading(false);
        }
    }

    // Listeners de Eventos
    queryButton.addEventListener('click', fetchTideData);

    // Inicialização 
    window.onload = () => {
        // Define a data de teste inicial (2025-10-19)
        dateInput.value = "2025-10-19";
    };

</script>

</body>
</html>

